<!-- TOC -->

- [进程间通信](#进程间通信)
- [一. 发送消息](#一-发送消息)
    - [主进程向面板panel发送消息](#主进程向面板panel发送消息)
    - [面板向主进程发送消息](#面板向主进程发送消息)
    - [其他消息发送方法](#其他消息发送方法)
- [二. 接收消息](#二-接收消息)
    - [面板渲染进程消息监听](#面板渲染进程消息监听)
    - [主进程消息监听](#主进程消息监听)
    - [其他消息监听方式](#其他消息监听方式)
- [三. 向消息来源发送回调](#三-向消息来源发送回调)
- [四. 消息超时处理](#四-消息超时处理)

<!-- /TOC -->
## 进程间通信
参考[IPC简介](https://docs.cocos.com/creator/manual/zh/extension/introduction-to-ipc.html)

## 一. 发送消息

### 主进程向面板panel发送消息

```javascript
Editor.Ipc.sendToPanel('panelID', 'message' [, ...args, callback, timeout])
```
**参数：**  
* panelID  
面板的ID 对于单面板扩展包来说 就是**插件的包名**
* message  
是 IPC 消息的全名，如 do-some-work，我们推荐在定义 IPC 消息名时使用 - 来连接单词，而不是使用驼峰或下划线。
* args  
**可选**  
从第三个参数开始，可以定义数量不定的多个传参，用于传递更具体的信息到面板进程。
* callback  
**可选**
在传参后面可以添加回调方法，在面板进程中接受到 IPC 消息后可以选择向主进程发送回调，并通过 callback 回调方法进行处理。回调方法的参数第一个是 error（如果没有错误则传入 null），之后才是传参。
* timeout
**可选**  
回调超时，只能配合回调方法一起使用，如果规定了超时，在消息发送后的一定时间内没有接到回调方法，就会触发超时错误。如果不指定超时，则默认的超时设置是 5000 毫秒。

### 面板向主进程发送消息

```javascript
Editor.Ipc.sendToMain('message', [, ...args, callback, timeout])
```


### 其他消息发送方法
* 任意进程对主进程**Editor.Ipc.sendToMain**
* 任意进程对面板**Editor.Ipc.sendToPanel**
* 任意进程对编辑器主窗口（也就是对主窗口里的所有渲染进程广播）**Editor.Ipc.sendToMainWin**
* 任意进程对所有窗口（对包括弹出窗口在内的所有窗口渲染进程广播）**Editor.Ipc.sendToWins**
* 任意进程对所有进程广播**Editor.Ipc.sendToAll**

## 二. 接收消息

要在主进程或渲染进程中接受 IPC 消息，最简单的办法是在声明对象的 messages 字段中注册以 IPC 消息为名的消息处理方法。

### 面板渲染进程消息监听

```javascript
Editor.Panel.extends({
    //...
    messages: {
        'my-message': function (event, ...args) {
            //do some work
        }
    }
});
```

### 主进程消息监听
```javascript
module.exports = {
    //...
    messages: {
        'my-message': function (event, ...args) {
            //do some work
        }
    }
}
```
### 其他消息监听方式

渲染进程中：
```javascript
require('electron').ipcRenderer.on('foobar:message', function(event, args) {});
```

主进程中：
```javascript
require('electron').ipcMain.on('foobar:message', function(event, args) {});
```

## 三. 向消息来源发送回调

假如我们从主进程发送了一个消息：
```js
//packages/foobar/main.js
Editor.Ipc.sendToPanel('foobar', 'greeting', 'How are you?', function (error, answer) {
    Editor.log(answer);
});
```
在面板监听消息的方法中，我们可以使用 event.reply 来发送回调：

```js
Editor.Panel.extends({
    //...
    messages: {
        'greeting': function (event, question) {
            console.log(question); //How are you?
            if (event.reply) {
                //if no error, the first argument should be null
                event.reply(null, 'Fine, thank you!');
            }
        }
    }
});
```

## 四. 消息超时处理

```
Editor.Ipc.sendToMain('foobar:greeting', function (error, answer) {
  if ( error && error.code === 'ETIMEOUT' ) { //check the error code to confirm a timeout
    Editor.error('Timeout for ipc message foobar:greeting');
    return;
  }
  Editor.log(answer);
});
```
