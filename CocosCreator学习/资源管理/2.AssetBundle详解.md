<!-- TOC -->

- [AssetBundle](#assetbundle)
    - [1.内置 Bundle](#1内置-bundle)
    - [2. 加载内置的Asset Bundle](#2-加载内置的asset-bundle)
    - [3.优先级](#3优先级)
    - [4.Asset Bundle 构造](#4asset-bundle-构造)

<!-- /TOC -->
## AssetBundle
从 v2.4 开始，Creator 正式支持 Asset Bundle 功能  
用于 减少启动时需要加载的资源量 减少首次下载和加载APP所需的事件

### 1.内置 Bundle
V2.4开始 项目所有的资源会放到Creator内置的4个AssetBundle中  


| 内置AssetBundle | 功能 | 配置 |
|:--|:--|:--|
|internal|存放所有内置资源以及依赖资源|通过配置internal中的resource文件夹目前不支持修改默认配置|
|main|存放参与构建的场景以及场景依赖的资源|通过**构建发布**面板的**主包压缩类型**和**配置主包为远程包**两项|
|resource|存放在resources目录下的所有资源及其依赖项|通过配置assets->resources文件夹|
|start-scene|在**构建**面板中勾选了**初始场景分包** 首场景将会被构建到start-scene中|不可配置|

### 2. 加载内置的Asset Bundle
如果是资源放在了服务器上 两种方式
* 通过**构建发布** 配置面板 配置 **资源服务器地址**
* 自定义构建模板 **main.js**   
实例代码
```js
let bundleRoot = [];
// 加入 internal bundle 的 URL 地址
bundleRoot.push('http://myserver.com/assets/internal');
// 如果有 resources bundle, 则加入 resources bundle 的 URL 地址
bundleRoot.push('http://myserver.com/assets/resources');
// 加入 main bundle 的 URL 地址
bundleRoot.push('http://myserver.com/assets/main');

var count = 0;
function cb (err) {
    if (err) {
        return console.error(err.message, err.stack);
    }
    count++;
    if (count === bundleRoot.length + 1) {
        cc.game.run(option, onStart);
    }
}

cc.assetManager.loadScript(settings.jsList.map(x => 'src/' + x), cb);

for (let i = 0; i < bundleRoot.length; i++) {
    cc.assetManager.loadBundle(bundleRoot[i], cb);
}
```

### 3.优先级
1. 文件夹设为Asset Bundle后 会将**文件夹中的资源**和**文件夹外的依赖资源**合并到一个Asset Bundle中,这可能会出现 某一资源不在Asset Bundle的文件中 却同时 被 多个Asset Bundle 所依赖

2. 在某一Asset Bundle中的资源 同时又被另一个Asset Bundle所依赖

解决以上问题 就需要调整Asset Bundle的**优先级**  
* 当同一资源被**不同优先级的**Asset Bundle引用时，资源会优先放在**优先级等级高**的Asset Bundle中，**低优先级的** 只会 保留一条存储记录。  
如果你想在**低优先级的Asset Bundle**中加载共享资源 **必须在之前加载高优先级的Asset Bundle.**
* 当同一资源被**同一优先级**的Asset Bundle引用时，资源在每个Asset Bundle中都会复制一份，不同的Asset Bundle之间没有依赖关系

**注意**  
所以请尽量确保共享的资源所在的 Asset Bundle 优先级更高，以便让更多低优先级的 Asset Bundle 共享资源，从而最小化包体。  

四个内置 Asset Bundle 文件夹的优先级分别为：

|Asset Bundle|优先级|
|:--|:--|
internal|11
main|7
resources|8
start-scene|9


### 4.Asset Bundle 构造
.   
├── config.json   
├── import  
├── index.js  
└── native  

* 代码   
文件夹中的所有代码会根据发布平台 合成一个 index.js 或者 game.js 的入口文件，并从主包中剔除。
* 资源  
**文件夹中的所有资源**和**依赖的外部资源** 会放到`import`或者`native`文件夹中。
* 资源配置  
所有资源的配置信息包括路径，类型，版本 都会被合并到一个 `config.json`文件中。
```json
{
    "paths": {
        "714W4sbRJFoKZ+Df2RJjTD": [
            "images/HelloWorld",
            "cc.SpriteFrame",
            1
        ],
    },
    "uuids": [
        "714W4sbRJFoKZ+Df2RJjTD",
    ],
    "scenes": {
        "db://assets/bundleTest/Scene/bundleTestScene.fire": "c5TnrcxWBBoJ0SbNZ1AZsz"
    },

    "name": "bundleTest",
    "importBase": "import",
    "nativeBase": "native",
    "debug": true,
    "isZip": false,
    "encrypted": false
}
```